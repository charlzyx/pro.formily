# ğŸ‘Š Pro ArrayTable

> Pro ArrayTable æ˜¯ä¸€ä¸ªå¢å¼ºç‰ˆæœ¬çš„ ArrayTable, å¢åŠ äº†ä»¥ä¸‹å±æ€§ä¸åŠŸèƒ½

- âœ… schema æ‹“å±•: RowExpand / Toolbar / Footer
- âœ… åˆ—é…ç½®: æ’åºä¸æ‹–åŠ¨è°ƒæ•´åˆ—å®½
- âœ… å¯ç¼–è¾‘å¼¹çª—, ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–
- âœ… å¸¸ç”¨åŠŸèƒ½é…ç½®ç®€åŒ–ä¸å¢å¼º (pagination/rowSelection/expandable)
- âœ… expandable.defaultExpandedAllRows ç°åœ¨æ”¯æŒæƒ°æ€§åŠ è½½å•¦!
- âœ… onSortEnd æ”¯æŒ `(from, end, arrayField) => Promise` å›è°ƒ!
- âœ… expandable.expandedRowKeys / rowSelection.selectedRowKeys ç°åœ¨ä¼šæ ¹æ®é¡µç è°ƒæ•´è¿›è¡Œæ™ºèƒ½é‡ç½®!

## è®¾è®¡æ€è·¯
 ProArrayTable çš„ç›®çš„å°±æ˜¯ç®€åŒ–å¸¸ç”¨è¡¨æ ¼æ“ä½œ, å¢å¼º Schema èƒ½åŠ›, åŒæ—¶, å¯¹å¼‚æ­¥æ“ä½œå‹å¥½;

ArrayTable æœ¬èº«æ˜¯å¯¹æœ¬åœ°æ•°æ®çš„ä¸€ä¸ªç¼–è¾‘æ–¹æ¡ˆ, ç¼ºå°‘ä¸€äº›å¼‚æ­¥çš„æ”¯æŒ, æ¯”å¦‚ onSort/onMoveUp/onMoveDown/onRemove ç­‰æ“ä½œéƒ½æ²¡æœ‰æ‹¦æˆª,
ç¼ºå°‘ç±»ä¼¼ [immber Patches](https://immerjs.github.io/immer/zh-CN/patches) å¤„ç†, ä¸å¥½å›é€€, è¿™åœ¨å¤„ç†è¿œç¨‹æ•°æ®çš„æ—¶å€™å°±éå¸¸éš¾å—äº†;
åŒæ—¶, ä¸€äº›é¢å¤–çš„åŠŸèƒ½, åˆ—é€‰æ‹©/åˆ—å±•å¼€æ— æ³•ä½¿ç”¨ Schema è¯­æ³•, é™åˆ¶äº†JSON Schema è¡¨ç°åŠ›.

**å¼¹å‡ºå±‚ç¼–è¾‘æ–¹æ¡ˆè®¾è®¡**

åœ¨è¿‡å¾€ä½¿ç”¨ formily çš„è¿‡ç¨‹ä¸­, è¡¨æ ¼ä¸­çš„å¼¹çª—ç¼–è¾‘ä¸€ä¸ªæ˜¯ä¸ªç—›ç‚¹, åŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨ä½¿ç”¨ FormDialog åšçš„å¤„ç†, é™¤äº†å† ShadowForm ä¸­æåˆ°çš„ FormDialog/FormDrwaer è‡ªèº«çš„é—®é¢˜,
åœ¨å®é™…ä½¿ç”¨ä¸­, ä¸€ç›´æŠŠ Formdialog æ¸²æŸ“åœ¨ eolumn çš„render ä¸­, è¿™å¯¼è‡´äº†å¤§é‡çš„ Modal è¢«åå¤åˆ›å»ºé”€æ¯ã€‚

ä¸ºä»€ä¹ˆä¸ç”¨äº‹ä»¶å§”æ‰˜ï¼Ÿ

1. éœ€è¦åœ¨è¡¨å•å¤–éƒ¨å¤„ç†å§”æ‰˜ä»£ç ï¼ˆä½†å…¶å®æ²¡æœ‰æ·±å…¥å°è¯•, æ¬¢è¿è®¨è®ºï¼‰
2. å¦ä¸€ä¸ªä¸»è¦åŸå› æ˜¯ formdialog ä¸­çš„è¡¨å•å®ä¾‹ç”Ÿå‘½å‘¨æœŸéš¾ä»¥ç†è§£ï¼ˆç°åœ¨æƒ³èµ·æ¥å¯èƒ½æ˜¯å› ä¸º initialvalues è¿·æƒ‘è¡Œä¸ºåŠ ä¸Šç†è§£é—®é¢˜å¯¼è‡´ï¼‰

ä½†æ€»ä¹‹, æˆ‘æƒ³åˆ°äº†æ›´å¥½çš„åŠæ³•ã€‚

è¿˜æ˜¯äº‹ä»¶å§”æ‰˜, ä½† builtin, ä½¿ç”¨ä¸€ä¸ªå†…ç½®çš„ DelegateContex æ¥ç®¡ç†è¡¨å•ä¸­çš„ click äº‹ä»¶, æ·»åŠ  data-å±æ€§ä½œä¸ºå¯ä»£ç†æ ‡å¿—, å¹¶æ·»åŠ è¡Œä¿¡æ¯æ¥åŒºåˆ†æ¥æºã€‚

å•çœ‹äº‹ä»¶å§”æ‰˜, å±å®å¹³å¹³æ— å¥‡, ä½†ä¸ ShadowForm ç»“åˆç€ç”¨æ‰èƒ½æ˜¾ç°å‡ºå·¨å¤§çš„æŠ›ç“¦


## å±æ€§è¯´æ˜

|å±æ€§|è¯´æ˜|ç±»å‹|é»˜è®¤å€¼|
|----|---|---|---|
|resizeable|å¯æ‹–æ‹½åˆ—å®½åŠŸèƒ½å¼€å…³, åœ¨ Columns ä¹Ÿå¯ä»¥å•ç‹¬è®¾ç½®|boolean|false|
|onSortEnd| æ‹–åŠ¨æ’åºå›è°ƒ, reject åˆ™æ‹’ç»æ‰§è¡Œæ’åº `(from: number, to: number, arrayField: ArrayField) => void |Promise\<void\>`|--|
|settings|åŠ¨æ€åˆ—æ’åºåŠŸèƒ½å¼€å…³| boolean |true|
|slice|åˆ†é¡µæ€§èƒ½ä¼˜åŒ–å¼€å…³, é»˜è®¤å¼€å¯| boolean| true|
|rowSelection|å¯é€‰åˆ—é€‰æ‹©åŠŸèƒ½, é…ç½®ç®€åŒ–, æä¾›åŠŸèƒ½é’©å­, é»˜è®¤å…³é—­|true\| TableProps['rowSelection']|--|
|pagination|åˆ†é¡µåŠŸèƒ½, é…ç½®ç®€åŒ–, æä¾›åŠŸèƒ½é’©å­, é»˜è®¤å¼€å¯, false æ˜¾å¼å…³é—­| false\| TableProps['pagination']|`{hideOnSingle:true}`|
|expandable|è¡Œå±•å¼€åŠŸèƒ½, é…ç½®ç®€åŒ–, æä¾›åŠŸèƒ½é’©å­é…ç½®, é»˜è®¤å…³é—­| TableProps['expandable']|--|
|RowExpand|Schame å½¢å¼çš„ è¡Œå±•å¼€|--|--|
|Toolbar|Schame  å½¢å¼çš„è‡ªå®šä¹‰è¡¨å¤´éƒ¨åˆ†å†…å®¹, è‡ªå®šä¹‰ç»„ä»¶åç§°å¿…é¡»åŒ…å« Toolbar|--|--|
|Footer|Schame  å½¢å¼çš„è‡ªå®šä¹‰è¡¨å¤´éƒ¨åˆ†å†…å®¹, è‡ªå®šä¹‰ç»„ä»¶åç§°å¿…é¡»åŒ…å« Footer |--|--|


## ä»£ç æ¡ˆä¾‹: åŸºæœ¬ä½¿ç”¨

<code src="../demos/ProArrayTable.tsx"  />

## ä»£ç æ¡ˆä¾‹:å¯ç¼–è¾‘å¼¹çª—

<code src="../demos/ProArrayTableWithShadow.tsx"  />

### ArrayBase ä»ç„¶é€‚ç”¨çš„API

- ArrayBase.useArray
- ArrayBase.useIndex
- ArrayBase.useRecord


### ä¸æ”¯æŒè¡¨æ ¼æ ‘å½¢æ•°æ®çš„å±•ç¤º, ä½†ä½ å¯ä»¥è¿™æ ·è¿‚å›ä¸€ä¸‹

```tsx | pure
// ä½¿ç”¨è¿™ä¸ªç»„ä»¶
const Indent = () => {
  const record = ArrayBase.useRecord?.();
  const indent = Array.from({ length: record?.indent }).fill("..").join(" ");
  return <span style={{ padding: "0 8px " }}>{indent}</span>;
};

const fluttenTree = (tree: Menu[], indent = 0) => {
  return tree.reduce<(Menu & { indent: number })[]>((flat, item) => {
    flat.push({
      ...item,
      // æ·»åŠ  indent
      indent,
      // è®°å¾—å»æ‰ children
      children: undefined,
    });
    if (item.children) {
      flat.push(...fluttenTree(item.children, indent + 1));
    }
    return flat;
  }, []);
};
```

### ProArrayTable.useTablePagination è·å–åˆ†é¡µä¿¡æ¯

```tsx | pure
export interface ITableSelectionContext {
  current: number;
  pageSize: number;
  total: number;
  setPagination: React.Dispatch<
    React.SetStateAction<{ current: number; pageSize: number }>
  >;
}
```

### ProArrayTable.useTableExpandable è·å– Expandable å±•å¼€è¡Œä¿¡æ¯

```tsx | pure
export interface ITableExpandableContext {
  // åˆ†é¡µé¡µç å˜æ›´ä¼šé‡ç½®
  expandedRowKeys: RowKey[];
  setExpandedRowKeys: React.Dispatch<React.SetStateAction<RowKey[]>>;
}
```

### ProArrayTable.useTableRowSelection è·å–åˆ—é€‰æ‹©ä¿¡æ¯

```tsx | pure
export interface ITableSelectionContext {
  selectedRowKeys: RowKey[];
  setSelectedRowKeys: React.Dispatch<React.SetStateAction<RowKey[]>>;
}
```

### ProArrayTable.useProArrayTableContext è·å–æ•°ç»„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯

```tsx | pure
export const useProArrayTableContext = () => {
  const array = ArrayBase.useArray();
  const pagination = useContext(TablePaginationContext);
  const rowSelection = useContext(TableRowSelectionContext);
  const expanedable = useContext(TableExpandableContext);
  return { array, pagination, rowSelection, expanedable };
};
```

### ProArrayTable.DelegateAction ä»£ç†åŠ¨ä½œè§¦å‘å™¨

ä»£ç†åŠ¨ä½œè§¦å‘å™¨, ç»™å­ç»„ä»¶æ‰“æ ‡è®°, Table Wrapper çš„ click äº‹ä»¶ç»‘å®šè¿›è¡Œåˆ†å‘å¤„ç†, é€šè¿‡ `act` ä¸ ShadowForm å¼¹çª—ç³»åˆ—å…³è”

```tsx | pure
{
  /** åŠ¨ä½œæ ‡å¿—, ä¸ ShadowModal å¯¹åº”  */
  act: string;
  /** å½“å‰åˆ—æ‰€å± index, é»˜è®¤ä½¿ç”¨ ArrayBase.useIndex() è·å–å½“å‰æ•°æ®å¯¹åº”ä½ç½® */
  index?: number;
  /** æ•°æ®åˆå§‹åŒ–åŠ è½½å™¨, é»˜è®¤ä½¿ç”¨ field.record å½“å‰æ¨¡å‹æ‰€å¯¹åº” record */
  initLoader?: (record?: any) => object | Promise<object>;
  /**
   * å…·ä½“å…ƒç´ , ä½†å¿…é¡»æœ‰æ ‡ç­¾åŒ…è£…, å› ä¸ºä¼šè¢«è¿½åŠ  data-å±æ€§å­—æ®µæ ‡å¿—ç»™äº‹ä»¶å§”æ‰˜æ¥è¯†åˆ«
   * ä¸å¡«å†™çš„æƒ…å†µä¸‹, ä½¿ç”¨ Button æ ‡ç­¾åŒ…è£… field.title
   */
  children?: React.ReactElement;
}
```

### ShadowModal/ShadowDrawer é€šç”¨å±æ€§

é‰´äºè¿™å¥—ç»„ä»¶åœ¨ ProArrayTable ä¸­ä½¿ç”¨é¢‘ç‡é¢‡é«˜, èåˆäº† IShadowFormOptions ,å¼¹çª— å±æ€§ç»„åˆæˆä¸€ä¸ªç»„ä»¶, å¹¶åœ¨å›è°ƒç§æ³¨å…¥å½“å‰æ•°ç»„çš„ Context

```tsx | pure
{
  /** åŠ¨ä½œæ ‡å¿—, ä¸ ShadowModal å¯¹åº”, ä¸å¡«å†™çš„è¯,å–å½“å‰ schema çš„ name  */
  act?: string;
  /** å–æ¶ˆäº‹ä»¶ */
  onCancel?: (
    ctx: ReturnType<typeof ProArrayTable.useProArrayTableContext>,
  ) => void | Promise<void>;
  /** å­è¡¨å•æäº¤äº‹ä»¶, å¯ä»¥åšç‚¹ä»€ä¹ˆ */
  onOk?: (
    data: any,
    ctx: ReturnType<typeof ProArrayTable.useProArrayTableContext>,
  ) => void | Promise<void>;
} & IShadowFormOptions
```

### ProArrayTable.ShadowModal è¡¨æ ¼å…±äº«å¼¹çª—, ç»“åˆ ShadowForm#DelegateAction ä½¿ç”¨
é™¤äº† `onOk,onCancel` antd/Modal å…¶ä»–å±æ€§

### ProArrayTable.ShadowDrawer è¡¨æ ¼å…±äº«æŠ½å±‰, ç»“åˆ ShaodwForm#DelegateAction ä½¿ç”¨
> Welcome PR.

### ProArrayTable.ProAddition å¼¹çª—/æŠ½å±‰å½¢å¼çš„å¯ç¼–è¾‘å†…å®¹æ–°å¢ç»„ä»¶

é«˜çº§è‡ªå¢ç»„ä»¶, æä¾›äº†å¼¹çª—/æŠ½å±‰å½¢å¼çš„ç©ºè°ƒç¼–è¾‘å†…å®¹, è¿™ä¸ªæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå†…ç½®äº†ä¸€ä¸ª ShadowFormçš„ Modal/Drawer

```tsx | pure
{
  /** å­è¡¨å•Schema */
  schema: ISchema,
  /** createForm åˆ›å»ºçš„è¡¨å•å®ä¾‹, æœ‰è‡ªå®šä¹‰ effects ç­‰å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ä¸€ä¸ª form è¿™ä¸ªä¼ å…¥ */
  form?: ReturnType<typeof createForm>,
  /** createSchemaField å‡½æ•°é…ç½® */
  schemaFieldOptions?: Parameters<typeof createSchemaField>[0],
  /** å¼¹çª—å½¢å¼: Modal æˆ– Drawer, é»˜è®¤ modal  */
  popType: "modal" | "drawer"
  /** å…¶ä»– Modal / Drawer åŸå§‹å±æ€§ */
  ...others: React.ComponentProps<typeof Modal | typeof Drawer>
}
```

### ProArrayTable.Column è¡¨æ ¼åˆ—

> è¿½åŠ äº†å¯æ‹–æ‹½åˆ—å®½é…ç½®å¼€å…³, ä¼˜å…ˆçº§ > Table ä¸Šçš„ resizeable å±æ€§

å…¶ä»–ä¸ `@formily/antd` ä¸­çš„ `ArrayTable.Column` è¡¨ç°ä¸€è‡´


```tsx | pure
{
  // æ˜¯å¦å¯æ‹–æ‹½è°ƒæ•´åˆ—å®½
  resizeable?: boolean
  // ... å…¶ä»–å‚è€ƒ @formily/antd ArrayBase.Column  é…ç½®
}
```

## ArrayBase åŸºç¡€äº‹ä»¶æ·»åŠ  Promise æ”¯æŒ, å½±å“ç»„ä»¶åˆ—è¡¨å¦‚ä¸‹
```tsx | pure
export interface IProArrayTableBaseMixins {
  onSortEnd?: (
    form: number,
    to: number,
    arrayField: ArrayField,
  ) => void | Promise<void>;
  onAdd?: (
    toIndex: number,
    value: any,
    arrayField: ArrayField,
  ) => void | Promise<void>;
  onCopy?: (
    distIndex: number,
    value: any,
    arrayField: ArrayField,
  ) => void | Promise<void>;
  onRemove?: (index: number, arrayField: ArrayField) => void | Promise<void>;
  onMoveUp?: (index: number, arrayField: ArrayField) => void | Promise<void>;
  onMoveDown?: (index: number, arrayField: ArrayField) => void | Promise<void>;
}
```

- ProArrayTable.SortHandle
- ProArrayTable.Remove
- ProArrayTable.Copy
- ProArrayTable.MoveDown
- ProArrayTable.MoveUp
- ProArrayTable.Index
