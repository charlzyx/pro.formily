# 📕 Dict - 远程词典

> Formily 模型中的 `enum` 字段能够满足本地的枚举词典的需求, 但远程的其实更常用一些;


## 设计思路

业务中一个常见的场景是，从远程拉取一个 kv 词典列表, 作为 `Select/Checkbox.Group/Radio.Group/` 的 `options` 使用;
根据对应的 `key` 值获取对应的 `value` 值展示出来, 亦或反向的根据 `value` 取出 `key` 值;

使用基本的归纳演绎法, 可以使用一个约定的数据格式与方式, 将这些类似的场景中使用模式固定下来.

设计一个词典的标准结构约定如下:

```tsx | pure
export type TDictShape = {
  // 双向映射表
  emap: {
    [x: string]: string | number;
    [x: number]: string | number;
  };
  // 列表形式的存储
  options: {
    label: string;
    value: string | number;
    key?: string | number;
    color?: ColorsKey;
  }[];
  // on more things~ 因为会在 Tag/Badge 中使用, 额外增加的颜色配置
  colors: {
    [x: string]: string;
    [x: number]: string;
  };
};
```

当然我们并不希望填写这么多属性值, 继续约定一个最基本的原始数据 `label/value`, 其余属性我们都可以转换出来.

```tsx | pure
type DictLoader = () => Promise<{ label: string, value: string | number, color: string }>
// 当然, 不可能只有一个词典对不对
type registerDictLoader = (name: string, loader: DictLoader) => Promise<TDictShape>
```

## 最终实现

```tsx | pure
import { registerDictLoader, dict } from '@pro.formily/antd'
```

约定一个标准的词典加载器 `registerDictLoader`, 根据命名将对应词典注册到内存中的全局缓存;

一个最简单的例子

> color 并不是必填项,  不填写的话，会根据内置的10个颜色顺序读取

```tsx | pure
// 注册
const loader = registerDictLoader("bool", () => {
  return Promise.resolve([
    { label: "是", value: 1 },
    { label: "否", value: 0, color: "error" },
  ]);
});
// 与使用
loader().then(dictshape => console.log(dictshape))
// or
dict.bool?.emap
```

另一个导出 `dict` 是一个全局唯一的 `observeable({})` 值, 结合 `observer`, 我们可以很方便的在组件中使用

### 代码案例: 结合 `observer` 中使用

<code src="../demos/DictDemo2.tsx" />

在 Formily 中使用的话, 我们可以结合 `effect` 和 `schema` 配置,
```tsx | pure
import { dictEffects } from '@pro.formily/antd';
const form = createForm({
  effects(form) {
    dictEffects(form)
  }
})

const schema = {
  type: 'string',
  "x-component": "Select",
  "x-data": {
    // 词典名称;
    dict: "bool",
    // 默认进行缓存;
    dictNoCache: false,
  },
}
```

利用 Schema 使用 `x-data` 字段, 添加了词典属性, 在`dictEffects` 中, 惰性加载远程词典, 并注入 `field.dataSource/options` 属性;

额外的, `readPretty` 情况下劫持为优化形态 `Badge/Tag`

## 代码案例: 在 Formily 中使用

<code src="../demos/DictDemo.tsx" />

